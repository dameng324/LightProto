name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  linux-test:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Check format
        run: dotnet tool restore && dotnet tool run csharpier check .
        
      - name: Run tests
        run: dotnet test --configuration Release tests/LightProto.Tests/ -p:PublishAot=false

      - name: Run AOT tests
        run: |
          dotnet publish tests/LightProto.Tests/ -f net8.0 -r linux-x64 -c Release
          ./tests/LightProto.Tests/bin/Release/net8.0/linux-x64/publish/LightProto.Tests
          
          dotnet publish tests/LightProto.Tests/ -f net9.0 -r linux-x64 -c Release
          ./tests/LightProto.Tests/bin/Release/net9.0/linux-x64/publish/LightProto.Tests
          
      - name: Run Benchmarks
        run: |
          dotnet run -c Release --project ./tests/Benchmark -- --filter "*" --exporters github --artifacts ./BenchmarkResults
          cat ./BenchmarkResults/results/*.md >> $GITHUB_STEP_SUMMARY        
        
      - name: Post benchmark result as PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
         path: ./BenchmarkResults/results/*.md
      
      - name: Test package creation
        run: |
          dotnet pack --configuration Release --output ./test-packages src/LightProto/
  
  windows-test:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Check format
        run: dotnet tool restore && dotnet tool run csharpier check .
        
      - name: Run tests
        run: dotnet test --configuration Release tests/LightProto.Tests/ -p:PublishAot=false

      - name: Run AOT tests
        run: |
          dotnet publish tests/LightProto.Tests/ -f net8.0 -r win-x64 -c Release
          ./tests/LightProto.Tests/bin/Release/net8.0/win-x64/publish/LightProto.Tests.exe
          
          dotnet publish tests/LightProto.Tests/ -f net9.0 -r win-x64 -c Release
          ./tests/LightProto.Tests/bin/Release/net9.0/win-x64/publish/LightProto.Tests.exe

      - name: Test package creation
        run: |
          dotnet pack --configuration Release --no-build --output ./test-packages src/LightProto/
